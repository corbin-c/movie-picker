<!DOCTYPE html>
<html>
  <head>
    <title>La Bande à Nonce</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main>
    </main>
    <footer>
    </footer>
<script type="module">
const genres = [{"picture":"🚓","label":"Action","value":"action"},
  {"picture":"🗺️","label":"Aventure","value":"adventure"},
  {"picture":"🐭","label":"Animation","value":"animation"},
  {"picture":"📗","label":"Biographie","value":"biography"},
  {"picture":"🤣","label":"Comédie","value":"comedy"},
  {"picture":"🔪️","label":"Crime","value":"crime"},
  {"picture":"🎭","label":"Drame","value":"drama"},
  {"picture":"👪","label":"Famille","value":"family"},
  {"picture":"🦄","label":"Fantastique","value":"fantasy"},
  {"picture":"🕵️","label":"Film Noir","value":"film-noir"},
  {"picture":"📜","label":"Historique","value":"history"},
  {"picture":"🎃","label":"Horreur","value":"horror"},
  {"picture":"🎼","label":"Musique","value":"music"},
  {"picture":"🎤","label":"Comédie musicale","value":"musical"},
  {"picture":"❓","label":"Mystère","value":"mystery"},
  {"picture":"💞","label":"Romantique","value":"romance"},
  {"picture":"🛸","label":"Science-Fiction","value":"sci-fi"},
  {"picture":"🏀","label":"Sport","value":"sport"},
  {"picture":"😰","label":"Thriller","value":"thriller"},
  {"picture":"⚔️","label":"Guerre","value":"war"},
  {"picture":"🏜️","label":"Western","value":"western"}];

let displayGenres = (parent,callback) => {
  genres.map(genre => {
    let picture = document.createElement("p");
    picture.setAttribute("class","genres");
    picture.innerText = genre.picture;
    picture.addEventListener("click", (event) => {
      event.stopPropagation();
      callback(genre.value);
    });
    parent.append(picture)
  });
};

let settings = ((parent,methods) => {
  let output = {
    element: document.createElement("menu")
  }
  output.methods = methods;
  output.toggle = function() { this.element.classList.toggle("hidden") };
  output.updateGenres = function() {
    let list = this.methods.getGenres();
    [...this.element.querySelectorAll("div p")].map(e => {
      let value = genres.find(g => g.picture == e.innerText).value;
      if (list.indexOf(value) >= 0) {
        e.classList.add("selected")
      } else {
        e.classList.remove("selected")
      }
    });
  };
  output.element.classList.add("hidden");
  let filtr = document.createElement("h2");
  filtr.innerText = "Ajouter un genre :"
  output.element.append(filtr);
  let container = document.createElement("div");
  output.element.append(container);
  parent.append(output.element);
  //période temp
  //tri
  let home = document.createElement("p");
  home.innerText = "🏠";
  home.setAttribute("id","home");
  let orderH = document.createElement("h2");
  orderH.innerText = "Tri";
  let sort_key = document.createElement("select");
  let direction = document.createElement("select");
  let period = document.createElement("select");
  let createOpt = (select,key,value) => {
    let opt = document.createElement("option");
    opt.value = value;
    opt.innerText = key;
    select.append(opt);
  }; 
  [ {key:"Box Office US",value:"boxoffice_gross_us"},
    {key:"Alphabétique",value:"alpha"},
    {key:"Nombre d'avis",value:"num_votes"},
    {key:"Durée",value:"runtime"},
    {key:"Année",value:"year"}  ].map(e => {
    createOpt(sort_key,e.key,e.value);
  });
  [ {key:"décroissant",value:"desc"},
    {key:"croissant",value:"asc"}  ].map(e => {
    createOpt(direction,e.key,e.value);
  });
  let periodH = document.createElement("h2");
  periodH.innerText = "Période";
  ["indifférent",...(new Array(8)).fill(1940)].map((e,i) => {
    if (isNaN(e)) {
      createOpt(period,e,"");
    } else {
      e = (e+i*10);
      createOpt(period,"Années "+e,e+","+(9+e));
    }
  })
  home.addEventListener("click",() => { document.location.href = document.location.href });
  let toggleGenre = (value) => {
    output.methods.toggleGenre(value);
    output.updateGenres();
  }
  displayGenres(container,toggleGenre);
  output.updateGenres();
  period.addEventListener("change",(event) => {
    methods.updatePeriod(period.value);
  });
  sort_key.addEventListener("change",(event) => {
    methods.sort(sort_key.value,direction.value);
  });
  direction.addEventListener("change",(event) => {
    methods.sort(sort_key.value,direction.value);
  });
  output.element.addEventListener("click", function(event) {
    if (["select","option"].indexOf(event.target.nodeName.toLowerCase()) < 0) {
      output.toggle();
    }
  });
  output.element.append(orderH);
  output.element.append(sort_key);
  output.element.append(direction);
  output.element.append(periodH);
  output.element.append(period);
  let timeH = document.createElement("h2");
  timeH.innerText = "Période";  
  output.element.append(home);
  return output;
});

let infobox = ((parent) => {
  const elements = {
    date:"time",
    title:"h1",
    real:"h2",
    duration:"h4",
    genres:"h3",
    resume:"p"
  }
  let output = {
    element: document.createElement("article")
  }
  output.show = function(target) {
    target = target.getBoundingClientRect();
    target.x = target.left+target.width/2;
    target.y = target.top+target.height/2;
    let str = "";
    let position = 0; 
    /*
    *       0-------1
    *       |       |
    *       |       |
    *       3-------2
    */
    if (target.x > window.outerWidth-380) { //1 ou 2
      str += "right: "+(window.innerWidth-target.x+target.width/4)+"px; ";
      position++;
    } else { //0 ou 3
      str += "left: "+(target.x+target.width/4)+"px; ";
    }
    if (target.y > window.outerHeight-380) { //2 ou 3
      str += "bottom: "+(window.innerHeight-target.y+target.height/3)+"px; ";
      position += (position == 1) ? 1:3;
    } else { //0 ou 1
      str += "top: "+(target.y+target.height/3)+"px; ";
    }
    let border = ((radius,corner) => {
      let corners = [...new Array(4).fill(radius)].map((e,i) => {
        if (i == corner) {
          e = 0;
        }
        return e;
      });
      return "border-radius: "+corners.join("px ")+"px;";
    })(20,position);
    this.element.setAttribute("style",str+border);
    this.element.classList.remove("hidden");
  };
  output.hide = function() { 
    this.element.classList.add("hidden");
  };
  Object.keys(elements).map(e => {
    Object.defineProperty(output,e,{ set: function(value) {
      this.element.querySelector(elements[e]).innerText = value;
    }});
    output.element.append(document.createElement(elements[e]));
  });
  output.hide();
  output.element.addEventListener("click",() => { output.hide(); });
  parent.append(output.element);
  return output;
});

class Gallery {
  constructor(parentElement,genre) {
    this.parent = parentElement;
    this.status = {currentGrid:[]};
    this.sorted = "boxoffice_gross_us,desc"
    this.more = false;
    this.zoom = 12.5;
    this.view = "grid";
    this.ready = false;
    this.gridStatus = [];
    this.genre = genre;
    this.infobox = infobox(this.parent);
    this.settings = settings(document.querySelector("body"),{
      toggleGenre:(args) => {
        this.toggleGenre.call(this,args);
      },
      sort:(key,direction) => {
        this.setSort.call(this,key,direction)
      },
      getGenres:() => this.genre,
      updatePeriod:(period) => {
        this.period = period;
      }
    });
    [...document.querySelectorAll("button")].map(button => {
      if (["prev","dice"].indexOf(button.getAttribute("id")) < 0) {
        button.classList.remove("hidden");
      }
      button.addEventListener("click",() => {
        this[this.view][button.getAttribute("id")]();
      });
    });
  }
  grid = {
    next: () => {
      this.page++;
    },
    prev: () => {
      this.page--;
    },
    settings: () => {
      this.settings.toggle();
    },
    dice: () => {}
  }
  player = {
    next: () => {
      this.trailer++;
    },
    prev: () => {
      this.trailer--;
    },
    settings: () => {
      this.grid.settings();
    },
    dice: async () => {
      let randomMovie = await fetch("./random");
      randomMovie = await randomMovie.json();
      this.YTplayer(randomMovie.trailer);      
    }
  }
  setCSS(selector,key,value) {
    document.styleSheets[0].cssRules[
    [...document.styleSheets[0].cssRules].indexOf(
      [...document.styleSheets[0].cssRules]
        .find(e => e.selectorText == selector))].style[key] = value;
  }
  setStatus(key,value,verbose=false) {
    this.status[key] = value;
    if (verbose) { console.log(key,this.status[key]); }
  }
  toggleGenre(value) {
    let index = this.genre.indexOf(value);
    if (index < 0) {
      this.genre = [...this.genre,value];
    } else {
      this.status.genre.splice(index,1);
      this.genre = this.status.genre;
    }
  }
  setSort(key,direction) {
    this.sorted = key+","+direction;
    this.setStatus("start",null);
    this.page = 0;
  }
  set genre(value) {
    value = (typeof value === "string") ? [value]:value;
    this.setStatus("genre",value);
    this.setStatus("start",null);
    this.page = 0;
  }
  set period(value) {
    this.setStatus("period",value);
    this.setStatus("start",null);
    this.page = 0;
  }
  set page(value) {
    let start = 1;
    try {
      if ((typeof this.status.page === "unedfined")
        || (this.status.start === null)) {
        start = 1;
      } else {
        if (this.status.page < value) {
          start = (this.status.count+this.status.start || 1)
        } else {
          start = (this.status.start-this.status.count || 1)
        }
        start = Math.max(start,1);
      }
    } catch {
      console.log("page undefined");
    }
    this.setStatus("page",Math.ceil(start/this.status.count));
    this.show(this.status.count,start);
    if (this.status.page > 1) {
      document.querySelector("#prev").classList.remove("hidden");
    } else {
      document.querySelector("#prev").classList.add("hidden");
    }
  }
  set zoom(value) {
    this.setStatus("zoom",value);
    this.columns = Math.floor(100/this.zoom);
    this.rows = Math.floor((100*(window.outerHeight/window.outerWidth))
      /(this.zoom/0.683));
    this.status.count = this.rows*this.columns;
    this.setCSS("main","grid-template-columns","repeat("+this.columns+", 1fr)");
    this.setCSS("img","width",this.zoom+"vw"); 
    this.refresh();
  }
  set trailer(item_id) {
    this.view = "player";
    item_id = Math.max(0,item_id);
    this.setStatus("trailer",item_id);
    this.playTrailer(item_id);
    if (item_id > 0) {
      document.querySelector("#prev").classList.remove("hidden");
    } else {
      document.querySelector("#prev").classList.add("hidden");
    }
  }
  get genre() {
    return this.status["genre"];
  }
  get trailer() {
    return this.status["trailer"];
  }
  get page() {
    return this.status["page"];
  }
  get zoom() {
    return this.status["zoom"];
  }
  get period() {
    let period = this.status["period"];
    return (period == "") ? "":"&date="+period;
  }
  refresh() {
    if (([...this.parent.querySelectorAll("img")].length > 0)
      && (this.status.count > [...this.parent.querySelectorAll("img")].length)
      && this.ready && this.more) {
      console.log("refreshing...");
      this.show(this.status.count,this.status.start);
    }
  }
  async show(count,start) {
    this.ready = false;
    this.setStatus("count",count);
    this.setStatus("start",start); 
    let imdb = await fetch("./list?genre="+this.genre.join(",")+"&sort="+this.sorted+"&count="+this.status.count+this.period+"&start="+this.status.start);
    imdb = await imdb.json();
    [...this.parent.querySelectorAll("img")].map(e => {
      if (!imdb.some(movie => movie.cover === e.src)) {
        e.remove();
      }
    });
    imdb = imdb.filter(e => e.cover.indexOf("nopicture") < 0).map((e,i) => {
      let currentPoster = [...this.parent.querySelectorAll("img")].some(image => image.src == e.cover);
      if (!currentPoster) {
        let img = document.createElement("img");
        let promise_resolve;
        this.gridStatus[i] = new Promise((resolve,reject) => { promise_resolve = resolve; });
        img.setAttribute("alt",e.title);
        img.classList.add("loading");
        img.addEventListener("click",() => {
          this.trailer = i;
        });
        img.addEventListener("contextmenu",async (event) => {
          event.preventDefault();
          this.infobox.hide();
          await ((t) => { return new Promise((resolve,reject) => {
            setTimeout(resolve,t);
          })})(400);
          this.infobox.title = e.title;
          this.infobox.date = e.year;
          this.infobox.real = e.director;
          this.infobox.duration = e.duration;
          try {
            this.infobox.genres = e.genres.map(g => (genres.find(f => f.value == g.toLowerCase()).label || g)).join(" | ");
          } catch {
            this.infobox.genres = e.genres.join(" | ");
          }
          this.infobox.resume = e.abstract;
          this.infobox.show(img);
        });
        img.onload = () => {
          img.classList.remove("loading");
          promise_resolve();
        };
        img.src = e.cover;
        this.parent.append(img);
      }
      return e;
    });
    if (imdb.length >= count ) {
      this.more = true;
    } else {
      this.more = false;
    }
    Promise.all(this.gridStatus).then(e => {
      this.ready = true;
      this.refresh();
    });
    this.setStatus("currentGrid",imdb);
  }
  YTplayer(url) {
    [...this.parent.querySelectorAll("section")].map(e => e.remove());
    document.querySelector("#dice").classList.remove("hidden");
    let section = document.createElement("section");
    this.parent.append(section);
    let player = document.createElement("iframe");
    player.setAttribute("width",parseInt(section.getBoundingClientRect().width)-200);
    player.setAttribute("height",((parseInt(section.getBoundingClientRect().width)-200)/16)*9);
    player.setAttribute("frameborder",0);
    player.setAttribute("autoplay",true);
    player.setAttribute("src","https://www.youtube.com/embed/"+url+"?autoplay=1");
    section.append(player);  
    section.addEventListener("click", (e) => {
      [...this.parent.querySelectorAll("section")].map(e => e.remove());
      document.querySelector("#dice").classList.add("hidden");
      this.view = "grid";
    });
  }
  async playTrailer(id) {
    let trailer = await fetch("./trailer?title="+this.status.currentGrid[id].title);
    trailer = await trailer.json();
    trailer = trailer.trailer;
    this.YTplayer(trailer);
  }
}

(() => {
  let main = document.querySelector("main");
  let view;
  let zoomHandler = (event) => {
    let scale = view.zoom;
    if (event.deltaY < 0) {
      scale += 0.1;
    }
    else {
      scale -= 0.1;
    }
    scale = Math.min(Math.max(5, scale), 20);
    view.zoom = scale;
  }
  document.onwheel = zoomHandler;
  displayGenres(main,(genre) => {
    [...main.querySelectorAll("p")].map(e => e.remove());
    view = new Gallery(main,genre);
  });  
})()
/*(async () => {
  let z = await fetch("./random");
  z = await z.json();
  YTplayer(z.trailer);
})();
*/
</script>
<!--<script type="module" src="front.js"></script>-->
<button class="hidden" id="dice">🎲️️</button>
<button class="hidden" id="settings">⚙️️</button>
<button class="hidden" id="next">➡️</button>
<button class="hidden" id="prev">⬅️️</button>
  </body>
</html>
